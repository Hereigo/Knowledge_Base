<?xml version="1.0" encoding="utf-8"?>

<entity system-type="master" system-name="Commodity" display-name="Commodity" audit-log-display-name="Commodity"
        system-keephistory="true" security-isvalue="true" unique-relative-to="itself">

  <property system-name="Name" system-required="true" system-nameidentifier="true"
            system-type="string" system-size="20"
            display-name="Name"
    />
  <property system-name="CropYear" system-required="true"
      system-type="relation" relation-entity="CropYear"
      display-name="Crop Year" system-track-audit-log="true"
    />

  <data>
    <![CDATA[
        -- Fill temp table with data
        DECLARE @TempCommodity TABLE (
            Id int,
            Name nvarchar(20),
            CropYear bigint
        )
        INSERT INTO @TempCommodity(Id, Name, CropYear) VALUES
            (1, 'Wheat', 6), --'Jun/May crop year'
            (2, 'Corn', 9),  --'Sep/Aug crop year'
            (3, 'Barley', 6) --'Jun/May crop year'

        -- Perform Update, Insert
        UPDATE Commodity
            SET Name = source.Name,
                CropYear = source.CropYear
            FROM Commodity dest
            INNER JOIN @TempCommodity source ON dest.Id = source.Id

        SET IDENTITY_INSERT Commodity ON;

        INSERT INTO Commodity (Id, Name, CropYear)
            SELECT Id, Name, CropYear
            FROM @TempCommodity
            WHERE Id not in (SELECT Id FROM Commodity)

        SET IDENTITY_INSERT Commodity OFF;
]]>
  </data>

  <data multiple-run="true">
    <![CDATA[
        -- add create trigger
        IF EXISTS (SELECT *  
            FROM   sys.objects  
            WHERE  [type] = 'TR' 
            AND    [name] = 'trg_fill_CountryExporter')  
        DROP TRIGGER trg_fill_CountryExporter
        GO
        
        EXEC ('CREATE TRIGGER trg_fill_CountryExporter ON [Commodity]
            AFTER INSERT
            AS
            BEGIN
              DECLARE @Id int;
              SELECT @Id = IDENT_CURRENT(''Commodity'')
              IF @Id IS NOT NULL
                BEGIN
                  Insert Into ExporterCountryCommodity (Country, Commodity, IsMajorExporter, IsMajorImporter)
                  Select c.Id, @id, 0,0
                  from Country c
                END
            END')
]]>
  </data>
</entity>